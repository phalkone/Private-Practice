<table class="day">
  <thead>
    <tr>
      <th colspan="<%= @maxcols + 1 %>"><%= l(@date, :format => :long) %></th>
    </tr>
  </thead>
  <tbody>
    <% for i in 0..(((@stop-@start)*4)-1) %>
    <tr>
      <% if ((i % 4) == 0) %>
        <% hour = i/4 + @start %>
        <% hour = (hour.to_s.length < 2) ? "0" + hour.to_s : hour %> 
        <td rowspan="4" class="hour"><span class="big"><%= hour %></span><span class="superscript">00</span></td>
      <% end %>

      <% if @dayarray[i][0] == -1 %>
        <td colspan="<%= @maxcols %>"></td>
      <% elsif @dayarray[i][0] != -2 %>
        <% colspan = (@maxcols/@dayarray[i][0]) %>
        <% for j in 1..(@dayarray[i].length - 1) %>
          <% id = @dayarray[i][j].split("/")[0].to_i %>
          <% subid = @dayarray[i][j].split("/")[1].to_i %>
          <% app = @appointments.find_by_id(id).sub_appointments[subid] %>
          <td rowspan="<%= app.rowspan %>" colspan="<%= colspan %>" class="<%= (app.unbooked?) ? 'unbooked' : 'booked' %>">
            <div class="bar">
              <div class="bar2" style="margin-top:<%= app.top %>px;height:<%= app.duration %>px;">
              </div>
            </div>
            <%= l(app.begin, :format => :time) %>-<%= l(app.end, :format => :time) %>
            <% if app.unbooked? %>
              <%= link_to "", appointment_path(@appointments.find_by_id(id), :sub_id => subid), :remote => true, :class => "hidden" %>
              <% if @appointments.find_by_id(id).sub_appointments.length == 1 %>
                <%= link_to t("appointments.book_now").upcase, edit_appointment_path(@appointments.find_by_id(id), :mode => "registered"), :title => t("appointments.book_now").upcase, :remote => true %>
              <% else %>
                <%= link_to t("appointments.book_now").upcase, new_appointment_path(:appointment => {:begin_time => l(app.begin, :format => :time), :end_time => l(app.end, :format => :time), :date => l(app.begin, :format => :datepicker)}), :title => t("appointments.book_now").upcase, :remote => true %>
              <% end %>
            <% else %>
              <%= link_to app.patient.name, appointment_path(@appointments.find_by_id(id)), :title => app.patient.name, :remote => true %>
            <% end %>
            <%= link_to "", edit_appointment_path(@appointments.find_by_id(id)), :remote => true, 
        :class => "button ui-icon-wrench", :title => t("appointments.edit") %><%= link_to "", 
        @appointments.find_by_id(id), :remote => true, :confirm => t("appointments.confirmation"), :method => :delete, 
        :class => "button ui-icon-trash", :title => t("appointments.delete") %></td>
        <% end %>
      <% end %>
    </tr>
    <% end %>
  </tbody>
</table>
